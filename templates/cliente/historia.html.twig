{% extends 'base.html.twig' %}

{% block title %}Pacientes{% endblock %}
{% block panelTitle %}
    <div class="small">
        Nombre y Apellido: <small>{{ cliente.nombre }} {{ cliente.apellido }}</small><br>
        DNI: <small>{{ cliente.dni }}</small><br>
        Obra social: <small>{{ obraSociales[cliente.obraSocial] is defined ? obraSociales[cliente.obraSocial] : '' }}</small><br>
        Fecha de Ingreso: <small>{{ historiaPaciente[0].fechaIngreso ? historiaPaciente[0].fechaIngreso|date('Y-m-d') : ''}}</small><br>
        {% if historiaPaciente[0].fechaEngreso %}
        Fecha de Egreso: <small>{{ historiaPaciente[0].fechaEngreso ? historiaPaciente[0].fechaEngreso|date('Y-m-d') : '' }}</small>
        {% endif %}
    </div>
{% endblock %}
{% block body %}
    <div class="row">
        <div class="col-4">
            <h2>Historia Clínica</h2>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <h4 style="border-top: 1px solid; padding-top: 10px">Al Ingreso</h4>
            <table class="table table-responsive table-striped">
                {% if ingreso is not empty %}
                <tr>
                    <th>Antecedentes:</th>
                </tr>
                <tr>
                    <td>{{ ingreso.antecedentesTexto }}</td>
                </tr>
                <tr>
                    <th>Enfermedad Actual:</th>
                </tr>
                <tr>
                    <td>{{ ingreso.enfermedadActual }}</td>
                </tr>
                <tr>
                    <th>Exámen Físico al ingreso:</th>
                </tr>
                <tr>
                    <td>{{ ingreso.examenFisicoAlIngreso }}</td>
                </tr>
                <tr>
                    <th>Exámen Complementario:</th>
                </tr>
                <tr>
                    <td>{{ ingreso.examenComplementarioDesc }}</td>
                </tr>
                <tr>
                    <th>Indicaciones:</th>
                </tr>
                <tr>
                    <td>{{ ingreso.indicaciones }}</td>
                </tr>
                <tr>
                    <th>Adjuntos:</th>
                </tr>
                <tr>
                    <td>
                        {% if ingreso.examenesComplementeriosFiles is not empty %}
                            {% for examenes in ingreso.examenesComplementeriosFiles %}
                                {{ examenes }}<br>
                            {% endfor %}
                        {% else %}
                            No tiene
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    No existen registros
                </tr>
                {% endif %}
            </table>
        </div>
        <div class="col-12">
            <h4 style="border-top: 1px solid; padding-top: 10px">Notas</h4>
            {% if notasHistoria is not empty %}
            <table class="table table-responsive table-wrapper-scroll-y my-custom-scrollbar" >
                <tbody>
                {% for nota in notasHistoria %}
                    <tr style="background-color: #dee2e6">
                        <td>{{ nota.fecha ? nota.fecha|date('Y-m-d') : ''}}</td>
                    </tr>
                    <tr>
                        <td>{{ nota.text }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}
            No existen registros
            {% endif %}
            <br><br><br>
            <h4 style="border-top: 1px solid; padding-top: 10px">Notas en Turnos</h4>
            {% if notasTurnos is not empty %}
            <table class="table table-responsive table-wrapper-scroll-y" >
                <tbody>
                {% for turno in notasTurnos %}
                    <tr style="background-color: #dee2e6">
                        <td>{{ turno.fecha ? turno.fecha|date('Y-m-d') : ''}}</td>
                    </tr>
                    {% for nota in turno.notas %}
                        <tr><td>{{ nota }}</td></tr>
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>
            {% else %}
                No existen registros
            {% endif %}
            <br><br><br>
            <h4 style="border-top: 1px solid; padding-top: 10px">Evoluciones</h4>
            {% if evoluciones is not empty %}
            <table class="table table-responsive table-wrapper-scroll-y" >
                <tbody>
                {% for evolucion in evoluciones %}
                    <tr style="background-color: #dee2e6; display: table; width: 100%; table-layout: fixed;">
                        <td>{{ evolucion.fecha ? evolucion.fecha|date('Y-m-d') : ''}} - {{ evolucion.tipo }}</td>
                    </tr>
                    <tr>
                        <td>{{ evolucion.description }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}
                No existen registros
            {% endif %}
            <h4 style="padding-top: 10px; border-top: 1px solid;">Novedades</h4>
            {% if historiaPaciente is not empty %}
            <table class="table table-responsive table-striped table-wrapper-scroll-y">
                <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Cambio</th>
                    <th>Usuario</th>
                </tr>
                </thead>
                <tbody>
                {% for key, historia in historiaPaciente %}
                    <tr>
                        {% if key > 0 %}
                            <td>{{ historia.fecha ? historia.fecha|date('Y-m-d') : ''}}</td>
                            <td class="lowercase">
                                {% if historia.modalidad != historiaPaciente[key - 1].modalidad %}
                                    <b class="text-capitalize">modalidad:</b> de <b class="text-capitalize">
                                    {% if(historiaPaciente[key - 1].modalidad == 1) %}
                                        Ambulatorio
                                    {% elseif(historiaPaciente[key - 1].modalidad == 2) %}
                                        Internacion
                                    {% elseif(historiaPaciente[key - 1].modalidad == 3) %}
                                        Hospital de día
                                    {% elseif(historiaPaciente[key - 1].modalidad == 4) %}
                                        ART
                                    {% endif %}
                                </b>
                                    a
                                    <b class="text-capitalize">
                                        {% if(historia.modalidad == 1) %}
                                            Ambulatorio
                                        {% elseif(historia.modalidad == 2) %}
                                            Internacion
                                        {% elseif(historia.modalidad == 3) %}
                                            Hospital de día
                                        {% elseif(historia.modalidad == 4) %}
                                            ART
                                        {% endif %}
                                    </b>
                                    <br>
                                {% endif %}
                                {% if historia.patologia != historiaPaciente[key - 1].patologia %}
                                    <b class="text-capitalize">Patología:</b> de
                                    <b class="text-capitalize">
                                        {% if(historia.patologia == 1) %}
                                            Neurologicas
                                        {% elseif(historia.patologia == 2) %}
                                            Traumatológicas
                                        {% elseif(historia.patologia == 3) %}
                                            Respiratorias
                                        {% elseif(historia.patologia == 4) %}
                                            Paliativos
                                        {% elseif(historia.patologia == 4) %}
                                            Patologías laborales
                                        {% endif %}
                                    </b>
                                    a
                                    <b class="text-capitalize">
                                        {% if(historiaPaciente[key - 1].patologia == 1) %}
                                            Neurologicas
                                        {% elseif(historiaPaciente[key - 1].patologia == 2) %}
                                            Traumatológicas
                                        {% elseif(historiaPaciente[key - 1].patologia == 3) %}
                                            Respiratorias
                                        {% elseif(historiaPaciente[key - 1].patologia == 4) %}
                                            Paliativos
                                        {% elseif(historiaPaciente[key - 1].patologia == 4) %}
                                            Patologías laborales
                                        {% endif %}
                                    </b>
                                    <br>
                                {% endif %}
                                {% if historia.patologiaEspecifica != historiaPaciente[key - 1].patologiaEspecifica %}
                                    <b class="text-capitalize">Patologia Especifica:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].patologiaEspecifica }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.patologiaEspecifica }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.obraSocial != historiaPaciente[key - 1].obraSocial %}
                                    <b class="text-capitalize">Obra Social:</b>
                                    de
                                    <b class="text-capitalize">{{ (historiaPaciente[key - 1].obraSocial is not empty and obraSociales[historiaPaciente[key - 1].obraSocial] is not empty) ? obraSociales[historiaPaciente[key - 1].obraSocial] : 'Vacío' }}</b>
                                    a
                                    <b class="text-capitalize">{{ (historia.obraSocial is not empty and obraSociales[historia.obraSocial] is not empty) ? obraSociales[historia.obraSocial] : 'Vacío' }}</b>
                                    <br>
                                {% endif %}

                                {% if historia.nAfiliadoObraSocial != historiaPaciente[key - 1].nAfiliadoObraSocial %}
                                    <b class="text-capitalize">Nº Afiliado OS:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].nAfiliadoObraSocial }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.nAfiliadoObraSocial }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.sistemaDeEmergencia != historiaPaciente[key - 1].sistemaDeEmergencia %}
                                    <b class="text-capitalize">Sistema De Emergencia:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].sistemaDeEmergencia }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.sistemaDeEmergencia }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.nAfiliadoSistemaDeEmergencia != historiaPaciente[key - 1].nAfiliadoSistemaDeEmergencia %}
                                    <b class="text-capitalize">Nº Afiliado SdE:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].nAfiliadoSistemaDeEmergencia }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.nAfiliadoSistemaDeEmergencia }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.habitacion != historiaPaciente[key - 1].habitacion %}
                                    <b class="text-capitalize">habitacion:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].habitacion }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.habitacion }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.cama != historiaPaciente[key - 1].cama %}
                                    <b class="text-capitalize">cama:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].cama }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.cama }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.fechaIngreso != historiaPaciente[key - 1].fechaIngreso %}
                                    <b class="text-capitalize">Fecha de Ingreso:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].fechaIngreso | date('Y-m-d') }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.fechaIngreso | date('Y-m-d') }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.fechaDerivacion != historiaPaciente[key - 1].fechaDerivacion %}
                                    <b class="text-capitalize">Fecha de Derivacion:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].fechaDerivacion is not empty ? historiaPaciente[key - 1].fechaDerivacion | date('Y-m-d') : 'Vacío' }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.fechaDerivacion is not empty ? historia.fechaDerivacion | date('Y-m-d') : 'Vacio' }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.fechaReingresoDerivacion != historiaPaciente[key - 1].fechaReingresoDerivacion %}
                                    <b class="text-capitalize">Fecha de reingreso de Derivacion:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].fechaReingresoDerivacion is not empty ? historiaPaciente[key - 1].fechaReingresoDerivacion | date('Y-m-d') : 'Vacío' }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.fechaReingresoDerivacion is not empty ? historia.fechaReingresoDerivacion | date('Y-m-d') : 'Vacio' }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.motivoDerivacion != historiaPaciente[key - 1].motivoDerivacion %}
                                    <b class="text-capitalize">Motivo de Derivacion:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].motivoDerivacion }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.motivoDerivacion }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.derivadoEn != historiaPaciente[key - 1].derivadoEn %}
                                    <b class="text-capitalize">Derivado En:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].derivadoEn }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.derivadoEn }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.empresaTransporteDerivacion != historiaPaciente[key - 1].empresaTransporteDerivacion %}
                                    <b class="text-capitalize">Empresa de Transporte de Derivacion:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].empresaTransporteDerivacion }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.empresaTransporteDerivacion }}</b>
                                    <br>
                                {% endif %}
                                {% if historia.fechaAltaPorPermiso != historiaPaciente[key - 1].fechaAltaPorPermiso %}
                                    <b class="text-capitalize">Fecha de Alta Por Permiso:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].fechaAltaPorPermiso is not empty ? historiaPaciente[key - 1].fechaAltaPorPermiso | date('Y-m-d') : 'vacio'}}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.fechaAltaPorPermiso is not empty ? historia.fechaAltaPorPermiso | date('Y-m-d') : 'vacio'}}</b>
                                    <br>
                                {% endif %}
                                {% if historia.fechaBajaPorPermiso != historiaPaciente[key - 1].fechaBajaPorPermiso %}
                                    <b class="text-capitalize">Fecha de Baja Por Permiso:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].fechaBajaPorPermiso is not empty ? historiaPaciente[key - 1].fechaBajaPorPermiso | date('Y-m-d') : 'vacio'}}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.fechaBajaPorPermiso is not empty ? historia.fechaBajaPorPermiso | date('Y-m-d') : 'vacio'}}</b>
                                    <br>
                                {% endif %}
                                {% if historia.dePermiso != historiaPaciente[key - 1].dePermiso %}
                                    <b class="text-capitalize">De Permiso:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].dePermiso is empty or historiaPaciente[key - 1].dePermiso == 0 ? 'no' : 'si' }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.dePermiso is empty or historia.dePermiso == 0 ? 'no' : 'si'}}</b>
                                    <br>
                                {% endif %}
                                {% if historia.ambulatorio != historiaPaciente[key - 1].ambulatorio %}
                                    <b class="text-capitalize">Ambulatorio:</b>
                                    de
                                    <b class="text-capitalize">{{ historiaPaciente[key - 1].ambulatorio is empty or historiaPaciente[key - 1].ambulatorio == 0 ? 'no' : 'si' }}</b>
                                    a
                                    <b class="text-capitalize">{{ historia.ambulatorio is empty or historia.ambulatorio == 0 ? 'no' : 'si'}}</b>
                                    <br>
                                {% endif %}
                            </td>
                            <td class="lowercase">{{ historia.usuario }}</td>
                        {% endif %}

                    </tr>
                {% else %}
                    <tr>
                        <td colspan="15">No existen registros</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}
                No existen registros
            {% endif %}
            <br>
            {% if historiaEgreso is not empty %}

                <h4 style="padding-top: 10px; border-top: 1px solid;">Epicrisis al ALta</h4>
                <table class="table table-responsive table-wrapper-scroll-y my-custom-scrollbar" >
                    <tbody>
                    {% for hist in historiaEgreso %}
                        <tr style="background-color: #dee2e6">
                            <td>{{ hist.fecha ? hist.fecha|date('Y-m-d') : ''}}</td>
                        </tr>
                        <tr>
                            <td>{{ hist.epicrisisAlta }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
    </div>
    <a class="btn btn-default" href="javascript:history.back();">volver</a>
{% endblock %}

{% block titleButtons %}
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalEpi">
        Epicrisis
    </button>

    <div class="modal fade bd-example-modal-lg" id="modalEpi" tabindex="-1" role="dialog" aria-labelledby="epicrisis" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Epicrisis</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <form method="get" id="epiform" action="{{ path('epicrisis', {'id': cliente.id}) }}">
                        <div class="form-group">
                            <label for="exampleInputEmail1">Epicrisis al Alta</label>
                            <textarea class="form-control" name="epicrisisAlAlta" id="epicrisisAlAlta" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Imprimir</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script>
        function onsubmited(event) {
            event.preventDefault();
            let epicrisisAlAltaText = $('#epicrisisAlAlta').val();
            $.ajax({
                url: "{{ path('guardar_epi', {'id': cliente.id}) }}",
                data: {
                    epicrisisAlAlta: epicrisisAlAltaText,
                },
                method: 'POST',
                success: function (response) {
                    $('body').find('.container-fluid').find('a').remove();
                    $('body').find('.container-fluid').find('button').remove();
                    $('.modal').remove();
                    let tables = $('body').find('.container-fluid').find('.table-wrapper-scroll-y');
                    tables.removeClass('table-wrapper-scroll-y');
                    let html = '<head>' + $('head').html() + '</head>';
                    html += $('body').find('.container-fluid').html();
                    html += '<div class="col-sm-12"><h4>Epicrisis al Alta</h4></div>';
                    html += '<div class="col-sm-12"><p>'+ epicrisisAlAltaText +'</p></div>';
                    imprimirElemento(html);
                    location.reload();
                }
            });
        }

        const epicForm = document.getElementById('epiform');
        epicForm.addEventListener('submit', onsubmited);
    </script>
{% endblock %}



